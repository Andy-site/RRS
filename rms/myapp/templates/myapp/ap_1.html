{% extends 'myapp/admin_page.html' %}
{% block welcome %}{% endblock %}

{% block content %}
    <h1>Manage Tables</h1>
    <form method="post" id="table-form">
        {% csrf_token %}
        <label for="date">Date:</label><br>
        <input type="date" id="date" name="date"><br>
        <label for="table">Table Size:</label><br>
        <select name="table" id="table">
            <option value="1">Table of 1</option>
            <option value="2">Table of 2</option>
            <option value="4">Table of 4</option>
            <option value="6">Table of 6</option>
            <option value="8">Table of 8</option>
        </select><br>
        <input type="submit" value="Show Tables">
        <button type="button" id="apply-changes">Apply Changes</button>
    </form>
    <div id="table-container">
        <!-- This is where you'll dynamically generate the table elements based on the selected date and table size. Each table element should have a class of either 'reserved' or 'unreserved'. -->
    </div>
{% endblock %}

{% block css %}
body {
    font-family: Arial, sans-serif;
}

form {
    width: 300px;
    margin: 0 auto;
}

label {
    display: block;
    margin-top: 20px;
}

input[type="date"],
select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
}

input[type="submit"],
#apply-changes {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
}

#apply-changes {
    background-color: #ff9800; /* Orange color */
}

#table-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
}

.table {
    width: calc(20% - 20px); /* Adjust as needed */
    margin: 10px;
    text-align: center;
    padding: 10px;
    border: 1px solid #ddd;
}

.reserved {
    background-color: red;
}

.unreserved {
    background-color: green;
}
{% endblock %}

{% block js %}
<script>
    document.getElementById('table-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent form submission
        showTables();
    });

    document.getElementById('apply-changes').addEventListener('click', function() {
        applyChanges();
    });

    document.getElementById('table-container').addEventListener('click', function(event) {
        if (event.target.classList.contains('table')) {
            toggleReservation(event.target);
        }
    });

    function showTables() {
        // Get the selected date and table size
        var date = document.getElementById('date').value;
        var tableSize = parseInt(document.getElementById('table').value);

        // Clear previous table elements
        document.getElementById('table-container').innerHTML = '';

        // Fetch table data from the server
        fetch(`/get-tables/?date=${date}&size=${tableSize}`)
            .then(response => response.json())
            .then(data => {
                // Create and append table elements based on server response
                data.forEach(function(tableData) {
                    if (tableData.number >= tableSize) {
                        var tableElement = document.createElement('div');
                        tableElement.textContent = `Table ${tableData.number}`;
                        tableElement.setAttribute('data-id', tableData.id); // Add data-id attribute for identification
                        tableElement.className = 'table';

                        if (tableData.reserved) {
                            tableElement.classList.add('reserved');
                        } else {
                            tableElement.classList.add('unreserved');
                        }

                        document.getElementById('table-container').appendChild(tableElement);
                    }
                });
            });
    }

    function applyChanges() {
        // Save table state to the server
        var tables = document.querySelectorAll('.table');
        var updatedTables = [];
        tables.forEach(function(table) {
            updatedTables.push({
                id: table.getAttribute('data-id'),
                reserved: table.classList.contains('reserved')
            });
        });

        // Send updated table data to the server
        fetch('/update-table-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedTables)
        })
        .then(response => {
            if (response.ok) {
                alert('Changes applied successfully!');
            } else {
                alert('Failed to apply changes!');
            }
        });
    }

    function toggleReservation(tableElement) {
        if (tableElement.classList.contains('reserved')) {
            tableElement.classList.remove('reserved');
            tableElement.classList.add('unreserved');
        } else {
            tableElement.classList.remove('unreserved');
            tableElement.classList.add('reserved');
        }
    }

    // Call showTables function on page load
    showTables();
</script>

{% endblock %}
